<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Trafiknotifieringar</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
    }

    h1 {
      font-size: 1.8em;
      margin-bottom: 1em;
    }

    select, button {
      padding: 0.5em;
      font-size: 1em;
      margin-top: 0.5em;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin-bottom: 1em;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .sent {
      background-color: #e0ffe0;
    }

    .actions {
      margin-top: 0.5em;
    }

    .actions button {
      margin-right: 0.5em;
    }

    pre.sms-preview {
      background: #f8f8f8;
      padding: 0.5em;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>üì° Trafiknotifieringar ‚Äì Livefl√∂de</h1>

    <label for="countySelect">V√§lj l√§n:</label>
    <select id="countySelect" v-model="countyNo">
      <option disabled value="">-- V√§lj ett l√§n --</option>
      <option v-for="(name, id) in counties" :key="id" :value="id">{{ name }}</option>
    </select>

    <br />
    <button @click="fetchData" :disabled="loading">üîç H√§mta trafikdata</button>

    <ul>
      <li v-if="loading">üîÑ H√§mtar data fr√•n Trafikverket...</li>
      <li v-if="!loading && results.length === 0">‚úÖ Inga h√§ndelser just nu.</li>

      <li v-for="(dev, index) in results" :key="dev.Id" :class="{ sent: dev.sent }">
        <strong>{{ dev.Header || 'Trafikh√§ndelse' }}</strong><br />
        <span v-if="dev.Message">{{ dev.Message }}<br /></span>
        <small><em>{{ dev.MessageTypeValue || 'Typ ok√§nd' }} p√• v√§g {{ dev.RoadNumber || 'ok√§nd' }}</em></small>

        <pre class="sms-preview"><strong>SMS-preview:</strong>
{{ buildSmsPreview(dev) }}</pre>

        <div class="actions">
          <button @click="sendSms(dev, index)" :disabled="dev.smsSending">
            {{ dev.smsSending ? '‚è≥ Skickar SMS...' : dev.smsSent ? `‚úÖ SMS skickat (${dev.smsCount || 0})` : 'üì≤ Skicka SMS' }}
          </button>
          <button @click="sendEmail(dev, index)" :disabled="dev.emailSending">
            {{ dev.emailSending ? '‚è≥ Skickar Mail...' : dev.emailSent ? `‚úÖ Mail skickat (${dev.emailCount || 'OK'})` : 'üìß Skicka Mail' }}
          </button>
        </div>
      </li>
    </ul>
  </div>

  <script type="module">
    const { createApp, reactive } = Vue;

    createApp({
      setup() {
        const BASE_URL = "https://trafik-q8va.onrender.com";

        const counties = {
          1: "Stockholms l√§n",
          2: "Uppsala l√§n",
          3: "S√∂dermanlands l√§n",
          4: "√ñsterg√∂tlands l√§n",
          5: "J√∂nk√∂pings l√§n",
          6: "Kronobergs l√§n",
          7: "Kalmar l√§n",
          8: "Gotlands l√§n",
          9: "Blekinge l√§n",
          10: "Sk√•ne l√§n",
          12: "Hallands l√§n",
          13: "V√§stra G√∂talands l√§n",
          14: "V√§rmlands l√§n",
          17: "√ñrebro l√§n",
          18: "V√§stmanlands l√§n",
          19: "Dalarnas l√§n",
          20: "G√§vleborgs l√§n",
          21: "V√§sternorrlands l√§n",
          22: "J√§mtlands l√§n",
          23: "V√§sterbottens l√§n",
          24: "Norrbottens l√§n",
          25: "Utomlands (ej svenskt l√§n)"
        };
        

        const state = reactive({
          countyNo: "",
          counties,
          results: [],
          loading: false
        });

        function buildSmsPreview(dev) {
          const maxSmsLen = 160;
          const header = (dev.Header || dev.Title || "Trafikh√§ndelse").trim().substring(0, 60);
          const msg = (dev.Message || dev.Description || "").trim();
          const devId = dev.Id || "";
          const link = devId
            ? `https://www.trafikverket.se/trafikinformation/sok/?sok=${devId}`
            : "https://www.trafikverket.se/trafikinformation/";
          let shortDetails = "";
          if (msg) {
            const sentences = msg.split(". ");
            shortDetails = sentences.slice(0, 2).join(". ").trim();
            const allowedLen = maxSmsLen - link.length - header.length - 25;
            if (shortDetails.length > allowedLen) {
              shortDetails = shortDetails.substring(0, allowedLen).trim() + "‚Ä¶";
            }
          } else {
            shortDetails = "Ingen ytterligare information ‚Äì se l√§nk.";
          }
          return `üöß ${header}\n${shortDetails}\nL√§s mer: ${link}`;
        }

        async function fetchData() {
          state.loading = true;
          try {
            const res = await fetch(`${BASE_URL}/trafikinfo?county=${state.countyNo}`);
            const data = await res.json();
            state.results = data.map(d => ({ ...d, smsSent: false, emailSent: false }));
          } catch (e) {
            console.error("‚ö†Ô∏è Fel vid h√§mtning:", e);
            state.results = [];
          } finally {
            state.loading = false;
          }
        }

        async function sendSms(dev, index) {
          state.results[index].smsSending = true;
          try {
            const res = await fetch(`${BASE_URL}/api/send_sms_for_deviation`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                devId: dev.Id,
                countyNo: parseInt(state.countyNo),
                deviation: dev
              })
            });
            const json = await res.json();
            state.results[index].smsSent = true;
            state.results[index].smsCount = json.count || 0;
            state.results[index].sent = true;
          } catch (e) {
            console.error("‚ùå Fel vid SMS:", e);
          } finally {
            state.results[index].smsSending = false;
          }
        }

        async function sendEmail(dev, index) {
          state.results[index].emailSending = true;
          try {
            const res = await fetch(`${BASE_URL}/api/send_email_for_deviation`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                devId: dev.Id,
                countyNo: parseInt(state.countyNo),
                deviation: dev
              })
            });
            const json = await res.json();
            state.results[index].emailSent = true;
            state.results[index].emailCount = json.count || "OK";
            state.results[index].sent = true;
          } catch (e) {
            console.error("‚ùå Fel vid mail:", e);
          } finally {
            state.results[index].emailSending = false;
          }
        }

        return {
          ...Vue.toRefs(state),
          fetchData,
          sendSms,
          sendEmail,
          buildSmsPreview
        };
      }
    }).mount("#app");
  </script>
</body>
</html>
