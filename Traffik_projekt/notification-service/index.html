<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Trafiknotifieringar</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
    }
    select, button, input {
      padding: 0.5em;
      font-size: 1em;
      margin-top: 0.5em;
    }
    li {
      margin-bottom: 1em;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .sent {
      background-color: #e0ffe0;
    }
    pre {
      background: #f5f5f5;
      padding: 0.5em;
      border-radius: 4px;
      overflow-x: auto;
    }
    .actions button {
      margin-right: 1em;
    }
    .sms-preview {
      margin-top: 0.5em;
      font-family: monospace;
      font-size: 0.98em;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>üì° Trafiknotifieringar ‚Äì Livefl√∂de</h1>

  <label for="countySelect">V√§lj l√§n:</label>
  <select id="countySelect">
    <option value="" disabled selected>-- V√§lj ett l√§n --</option>
    <option value="1">Stockholms l√§n</option>
    <option value="2">V√§sterbottens l√§n</option>
    <option value="3">Uppsala l√§n</option>
    <option value="4">S√∂dermanlands l√§n</option>
    <option value="5">√ñsterg√∂tlands l√§n</option>
    <option value="6">J√∂nk√∂pings l√§n</option>
    <option value="7">Kronobergs l√§n</option>
    <option value="8">Kalmar l√§n</option>
    <option value="9">Gotlands l√§n</option>
    <option value="10">Blekinge l√§n</option>
    <option value="12">Sk√•ne l√§n</option>
    <option value="13">Hallands l√§n</option>
    <option value="14">V√§stra G√∂talands l√§n</option>
    <option value="17">V√§rmlands l√§n</option>
    <option value="18">√ñrebro l√§n</option>
    <option value="19">V√§stmanlands l√§n</option>
    <option value="20">Dalarnas l√§n</option>
    <option value="21">G√§vleborgs l√§n</option>
    <option value="22">V√§sternorrlands l√§n</option>
    <option value="23">J√§mtlands l√§n</option>
    <option value="24">V√§sterbottens l√§n</option>
    <option value="25">Norrbottens l√§n</option>
  </select>

  <br />
  <button id="fetchBtn">üîç H√§mta trafikdata</button>
  <ul id="results"></ul>

  <script>
    const BASE_URL = "https://trafik-q8va.onrender.com";

    // Hj√§lpfunktion f√∂r att bygga SMS-preview exakt som backend
    function buildSmsPreview(dev) {
      const maxSmsLen = 160;
      const header = (dev.Header || dev.Title || "Trafikh√§ndelse").trim().substring(0, 60);
      const msg = (dev.Message || dev.Description || "").trim();
      const devId = dev.Id || "";
      const link = devId
        ? `https://www.trafikverket.se/trafikinformation/sok/?sok=${devId}`
        : "https://www.trafikverket.se/trafikinformation/";
      let shortDetails = "";
      if (msg) {
        // Ta max tv√• meningar men trunkera snyggt om det blir f√∂r l√•ngt
        const sentences = msg.split(". ");
        shortDetails = sentences.slice(0, 2).join(". ").trim();
        const allowedLen = maxSmsLen - link.length - header.length - 25;
        if (shortDetails.length > allowedLen) {
          shortDetails = shortDetails.substring(0, allowedLen).trim() + "‚Ä¶";
        }
      } else {
        shortDetails = "Ingen ytterligare information ‚Äì se l√§nk.";
      }
      return `üöß ${header}\n${shortDetails}\nL√§s mer: ${link}`;
    }

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const countyNo = document.getElementById("countySelect").value;
      const results = document.getElementById("results");
      results.innerHTML = "<li>üîÑ H√§mtar data fr√•n Trafikverket...</li>";

      try {
        const res = await fetch(`${BASE_URL}/trafikinfo?county=${countyNo}`);
        const data = await res.json();
        results.innerHTML = "";

        if (!data.length) {
          results.innerHTML = "<li>‚úÖ Inga h√§ndelser just nu.</li>";
          return;
        }

        data.forEach(dev => {
          const li = document.createElement("li");
          const header = dev.Header || "Trafikh√§ndelse";
          const msg = dev.Message || "";
          const link = dev.Id
            ? `https://www.trafikverket.se/trafikinformation/sok/?sok=${dev.Id}`
            : "https://www.trafikverket.se/trafikinformation/";

          // Preview enligt samma logik som backend
          const preview = buildSmsPreview(dev);

          li.innerHTML = `
            <strong>${header}</strong><br>
            ${msg ? msg + "<br>" : ""}
            <small><em>${dev.MessageTypeValue || "Typ ok√§nd"} p√• v√§g ${dev.RoadNumber || "ok√§nd"}</em></small>
            <pre class="sms-preview"><strong>SMS-preview:</strong>\n${preview}</pre>
            <div class="actions">
              <button class="smsBtn">üì≤ Skicka SMS</button>
              <button class="emailBtn">üìß Skicka Mail</button>
            </div>
          `;

          li.querySelector(".smsBtn").addEventListener("click", async () => {
            const btn = li.querySelector(".smsBtn");
            btn.disabled = true;
            btn.innerText = "‚è≥ Skickar SMS...";
            try {
              const res = await fetch(`${BASE_URL}/api/send_sms_for_deviation`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  devId: dev.Id,
                  countyNo: parseInt(countyNo),
                  shortlinks: true,
                  deviation: dev 
                })
              });
              const json = await res.json();
              li.classList.add("sent");
              btn.innerText = `‚úÖ SMS skickat (${json.count || 0})`;
            } catch (err) {
              btn.innerText = "‚ùå Fel vid SMS";
              console.error(err);
            }
          });

          li.querySelector(".emailBtn").addEventListener("click", async () => {
            const btn = li.querySelector(".emailBtn");
            btn.disabled = true;
            btn.innerText = "‚è≥ Skickar Mail...";
            try {
              const res = await fetch(`${BASE_URL}/api/send_email_for_deviation`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  devId: dev.Id,
                  countyNo: parseInt(countyNo)
                })
              });
              const json = await res.json();
              li.classList.add("sent");
              btn.innerText = `‚úÖ Mail skickat (${json.count || "OK"})`;
            } catch (err) {
              btn.innerText = "‚ùå Fel vid mail";
              console.error(err);
            }
          });

          results.appendChild(li);
        });
      } catch (err) {
        console.error("‚ö†Ô∏è Kunde inte h√§mta data:", err);
        results.innerHTML = "<li>‚ùå Fel vid h√§mtning av data</li>";
      }
    });
  </script>
</body>
</html>
