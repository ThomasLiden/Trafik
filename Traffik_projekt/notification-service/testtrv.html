<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Trafikinformation ‚Äì Alla l√§n</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; }
    select, button { padding: 0.5em; margin-top: 1em; }
    li { margin-bottom: 1em; border: 1px solid #ccc; padding: 1em; border-radius: 5px; }
    .sent { background-color: #e7ffe7; }
  </style>
</head>
<body>
  <h1>Olyckor & V√§garbeten ‚Äì V√§lj l√§n</h1>

  <label for="countySelect">V√§lj l√§n:</label>
  <select id="countySelect">
    <option value="1">Stockholm</option>
    <option value="3">Uppsala</option>
    <option value="4">S√∂dermanland</option>
    <option value="5">√ñsterg√∂tland</option>
    <option value="6">J√∂nk√∂ping</option>
    <option value="7">Kronoberg</option>
    <option value="8">Kalmar</option>
    <option value="9">Gotland</option>
    <option value="10">Blekinge</option>
    <option value="12">Sk√•ne</option>
    <option value="13">Halland</option>
    <option value="14">V√§stra G√∂taland</option>
    <option value="17">V√§rmland</option>
    <option value="18">√ñrebro</option>
    <option value="19">V√§stmanland</option>
    <option value="20">Dalarna</option>
    <option value="21">G√§vleborg</option>
    <option value="22">V√§sternorrland</option>
    <option value="23">J√§mtland</option>
    <option value="24" selected>V√§sterbotten</option>
    <option value="25">Norrbotten</option>
  </select>

  <br />
  <button id="fetchBtn">üîÑ H√§mta Trafikdata</button>
  <ul id="results"></ul>

  <script>
    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const countyNo = document.getElementById("countySelect").value;
      const results = document.getElementById("results");
      results.innerHTML = "<li>üîÑ H√§mtar data...</li>";

      try {
        const res = await fetch(`http://localhost:5000/trafikinfo?county=${countyNo}`);
        const data = await res.json();
        results.innerHTML = "";

        if (data.length === 0) {
          results.innerHTML = "<li>Inga h√§ndelser just nu.</li>";
          return;
        }

        data.forEach(dev => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${dev.Header || "Ingen rubrik"}</strong><br>
            ${dev.Message || "Ingen beskrivning"}<br>
            <em>${dev.MessageTypeValue || "Ok√§nd typ"} p√• ${dev.RoadNumber || "ok√§nd v√§g"}</em><br>
            <button>üì≤ Skicka SMS</button>
          `;

          const button = li.querySelector("button");
          button.addEventListener("click", async () => {
            button.disabled = true;
            button.innerText = "‚è≥ Skickar...";
            try {
              const smsRes = await fetch("http://localhost:5000/api/send_sms_for_deviation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  devId: dev.Id,
                  countyNo: parseInt(countyNo, 10) 
                })
              });
              const result = await smsRes.json();
              li.classList.add("sent");
              button.innerText = `‚úÖ Skickade till ${result.count || 0}`;
            } catch (e) {
              console.error(e);
              button.innerText = "‚ö†Ô∏è Fel vid SMS";
            }
          });

          results.appendChild(li);
        });

      } catch (err) {
        console.error(err);
        results.innerHTML = "<li>‚ùå Fel vid h√§mtning av data.</li>";
      }
    });
  </script>
</body>
</html>
